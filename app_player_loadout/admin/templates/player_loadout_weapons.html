<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <title>Loadout do Jogador</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .weapon-card {
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.3s;
        }

        .weapon-card.selected {
            border: 2px solid #198754;
            /* verde Bootstrap */
            box-shadow: 0 0 10px rgba(25, 135, 84, 0.5);
        }

        .magazine-card {
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.3s;
        }

        .magazine-card.selected {
            border: 2px solid #198754;
            /* verde Bootstrap */
            box-shadow: 0 0 10px rgba(25, 135, 84, 0.5);
        }

        .ammo-card {
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.3s;
        }

        .ammo-card.selected {
            border: 2px solid #198754;
            /* verde Bootstrap */
            box-shadow: 0 0 10px rgba(25, 135, 84, 0.5);
        }

        .attachment-card {
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.3s;
        }

        .attachment-card.selected {
            border: 2px solid #198754;
            /* verde Bootstrap */
            box-shadow: 0 0 10px rgba(25, 135, 84, 0.5);
        }

        #attachments-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .attachment-card {
            position: relative;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden;
            background-color: #fff;
            text-align: center;
            padding: 5px;
        }

        .attachment-card img {
            width: 100%;
            height: 90px;
            object-fit: contain;
        }

        .attachment-card.selected {
            border-color: #198754;
            box-shadow: 0 0 6px #198754;
        }

        .attachment-name {
            font-size: 0.85rem;
            margin-top: 5px;
            text-overflow: ellipsis;
        }
        .btn-hover-effect {
            transition: all 0.3s ease;
        }
        .btn-hover-effect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-active {
            background-color: #0e1330; /* Cor de fundo quando o botão está ativo */
            color: white; /* Cor do texto */
        }
    </style>
</head>

<body class="container py-4">
    <h2>Loadout de {{ player.PlayerName or player.PlayerID }}</h2>
    <form method="post" action="{{ url_for('save_loadout_weapons', player_id=player.PlayerID) }}">
        <div class="row g-3 mb-4">
            <!-- Botão para Configurar Arma Primária -->
            <div class="col-md-4">
                <button class="btn btn-primary w-100 py-3 shadow-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrimary" aria-expanded="false" aria-controls="collapsePrimary">
                    <i class="fas fa-gun me-2"></i> Configurar arma primária
                </button>
            </div>
            
            <!-- Botão para Configurar Arma Secundária -->
            <div class="col-md-4">
                <button class="btn btn-primary w-100 py-3 shadow-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSecundary" aria-expanded="false" aria-controls="collapseSecundary">
                    <i class="fas fa-gun me-2"></i> Configurar arma secundária
                </button>
            </div>
            
            <!-- Botão para Configurar Arma Pequena -->
            <div class="col-md-4">
                <button class="btn btn-primary w-100 py-3 shadow-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSmall" aria-expanded="false" aria-controls="collapseSmall">
                    <i class="fas fa-gun me-2"></i> Configurar arma pequena
                </button>                
            </div>
            
        
        <div class="collapse mt-0" id="collapsePrimary">
            <!-- Seção Primary Weapon (existente) -->
            <div class="mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row mt-4" id="primary-weapon-list">
                            {% for weapon in weapons if weapon.slots >= 12 and not weapon.is_banned %}
                            <div class="col-md-3">
                                <div class="card weapon-card" data-weapon-id="{{ weapon.id }}"
                                    data-weapon-type="primary">
                                    <img src="{{ weapon.img }}" class="card-img-top" alt="{{ weapon.name }}">
                                    <div class="card-body text-center">
                                        <p class="card-text">{{ weapon.name }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="primary_weapon_id" id="primary_weapon_id">
                    </div>
                </div>
            </div>

            <div class="mb-3 d-none" id="div-primary-magazines">
                <div class="card">
                    <div class="card-body">
                        <h4 class="text-primary mb-4 text-center">Carregador Primário</h4>
                        <hr>
                        <div class="d-flex flex-wrap" id="primary-magazine-list">
                            <p>Selecione uma arma primeiro</p>
                        </div>
                        <input type="hidden" name="primary_magazine_id" id="primary_magazine_id">
                    </div>
                </div>
            </div>

            <div class="mb-3 d-none" id="div-primary-ammos">
                <div class="card">
                    <div class="card-body">
                        <h4 class="text-primary mb-4 text-center">Munição Primária</h4>
                        <hr>
                        <div class="d-flex flex-wrap" id="primary-ammo-list">
                            <p>Selecione uma arma primeiro</p>
                        </div>
                        <input type="hidden" name="primary_ammo_id" id="primary_ammo_id">
                    </div>
                </div>
            </div>

            <div class="mb-3 d-none" id="div-primary-attachments">
                <div class="card">
                    <div class="card-body">
                        <h4 class="text-primary mb-4 text-center">Acessórios Primários</h4>
                        <hr>
                        <div id="primary-attachments-section" class="row"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="collapse mt-0" id="collapseSecundary">
            <!-- Seção Secondary Weapon -->
            <div class="mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row mt-4" id="secondary-weapon-list">
                            {% for weapon in weapons if weapon.slots >= 12 and not weapon.is_banned %}
                            <div class="col-md-3">
                                <div class="card weapon-card" data-weapon-id="{{ weapon.id }}"
                                    data-weapon-type="secondary">
                                    <img src="{{ weapon.img }}" class="card-img-top" alt="{{ weapon.name }}">
                                    <div class="card-body text-center">
                                        <p class="card-text">{{ weapon.name }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="secondary_weapon_id" id="secondary_weapon_id">
                    </div>
                </div>
            </div>

            <div class="mb-3 d-none" id="div-secondary-magazines">
                <div class="card">
                    <div class="card-body">
                        <h4 class="text-primary mb-4 text-center">Carregador Secundário</h4>
                        <hr>
                        <div class="d-flex flex-wrap" id="secondary-magazine-list">
                            <p>Selecione uma arma primeiro</p>
                        </div>
                        <input type="hidden" name="secondary_magazine_id" id="secondary_magazine_id">
                    </div>
                </div>
            </div>

            <div class="mb-3 d-none" id="div-secondary-ammos">
                <div class="card">
                    <div class="card-body">
                        <h4 class="text-primary mb-4 text-center">Munição Secundária</h4>
                        <hr>
                        <div class="d-flex flex-wrap" id="secondary-ammo-list">
                            <p>Selecione uma arma primeiro</p>
                        </div>
                        <input type="hidden" name="secondary_ammo_id" id="secondary_ammo_id">
                    </div>
                </div>
            </div>

            <div class="mb-3 d-none" id="div-secondary-attachments">
                <div class="card">
                    <div class="card-body">
                        <h4 class="text-primary mb-4 text-center">Acessórios Secundários</h4>
                        <hr>
                        <div id="secondary-attachments-section" class="row"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="collapse mt-0" id="collapseSmall">
            <!-- Seção Small Weapon -->
            <div class="mb-3">
                <div class="card">
                    <div class="card-body mt-4">
                        <div class="row" id="small-weapon-list">
                            {% for weapon in weapons if weapon.slots < 12 and not weapon.is_banned %} 
                                <div class="col-md-3">
                                    <div class="card weapon-card" data-weapon-id="{{ weapon.id }}" data-weapon-type="small">
                                        <img src="{{ weapon.img }}" class="card-img-top" alt="{{ weapon.name }}">
                                        <div class="card-body text-center">
                                            <p class="card-text">{{ weapon.name }}</p>
                                        </div>
                                    </div>
                                </div>
                        {% endfor %}
                        </div>
                        <input type="hidden" name="small_weapon_id" id="small_weapon_id">
                    </div>
                </div>
            </div>

            <div class="mb-3 d-none" id="div-small-magazines">
                <div class="card">
                    <div class="card-body">
                        <h4 class="text-primary mb-4 text-center">Carregador Pequeno</h4>
                        <hr>
                        <div class="d-flex flex-wrap" id="small-magazine-list">
                            <p>Selecione uma arma primeiro</p>
                        </div>
                        <input type="hidden" name="small_magazine_id" id="small_magazine_id">
                    </div>
                </div>
            </div>

            <div class="mb-3 d-none" id="div-small-ammos">
                <div class="card">
                    <div class="card-body">
                        <h4 class="text-primary mb-4 text-center">Munição Pequena</h4>
                        <hr>
                        <div class="d-flex flex-wrap" id="small-ammo-list">
                            <p>Selecione uma arma primeiro</p>
                        </div>
                        <input type="hidden" name="small_ammo_id" id="small_ammo_id">
                    </div>
                </div>
            </div>

            <div class="mb-3 d-none" id="div-small-attachments">
                <div class="card">
                    <div class="card-body">
                        <h4 class="text-primary mb-4 text-center">Acessórios Pequenos</h4>
                        <hr>
                        <div id="small-attachments-section" class="row"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
        <div class="d-flex justify-content-between mt-4">
            <div>
                <button type="submit" class="btn btn-success">Salvar Loadout</button>
                <a href="{{ url_for('loadout_players') }}" class="btn btn-secondary">Voltar</a>

            </div>
            <a href="{{ url_for('delete_loadout', player_id=player.PlayerID) }}" class="btn btn-danger"
                onclick="return confirm('Tem certeza que deseja excluir?');">Resetar Loadout</a>
        </div>
    </form>
    <div class="mb-3 mt-3">
        <div class="card">
            <div class="card-body">
                <h4 class="text-success mb-4 text-center">Loadout salvo</h4>
                <hr>
                {% for label, prefix in [('Arma primária', 'primary'), ('Arma secundária', 'secondary'), ('Arma
                pequena', 'small')] %}
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="text-primary">{{ label }}</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <p><strong>Arma</strong></p>
                                        {% if loadout[prefix + '_weapon_img'] %}
                                        <img src="{{ loadout[prefix + '_weapon_img'] }}" class="card-img-top" alt="arma"
                                            style="max-height: 120px; object-fit: contain;">
                                        {% endif %}
                                        <p>{{ loadout[prefix + '_weapon_name'] }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <p><strong>Pente</strong></p>
                                        {% if loadout[prefix + '_magazine_img'] %}
                                        <img src="{{ loadout[prefix + '_magazine_img'] }}" class="card-img-top"
                                            alt="pente" style="max-height: 120px; object-fit: contain;">
                                        {% endif %}
                                        <p>{{ loadout[prefix + '_magazine_name'] }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <p><strong>Munição</strong></p>
                                        {% if loadout[prefix + '_ammo_img'] %}
                                        <img src="{{ loadout[prefix + '_ammo_img'] }}" class="card-img-top"
                                            alt="munição" style="max-height: 120px; object-fit: contain;">
                                        {% endif %}
                                        <p>{{ loadout[prefix + '_ammo_name'] }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% if attachments[prefix] %}
                        <div class="mt-4">
                            <h6 class="text-secondary">Acessórios</h6>
                            <div class="row g-3">
                                {% for att in attachments[prefix] %}
                                <div class="col-md-3">
                                    <div class="card h-100 text-center">
                                        <div class="card-body">
                                            <img src="{{ att.img }}" class="card-img-top" alt="{{ att.name }}"
                                                style="max-height: 120px; object-fit: contain;">
                                            <p class="mb-0">{{ att.name }}</p>
                                            <small class="text-muted">{{ att.type }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <!-- JS do Bootstrap (com Popper incluído) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Função genérica para lidar com a seleção de armas
            function setupWeaponSelection(weaponType) {
                const weaponCards = document.querySelectorAll(`.weapon-card[data-weapon-type="${weaponType}"]`);
                const weaponInput = document.getElementById(`${weaponType}_weapon_id`);

                const divMagazines = document.getElementById(`div-${weaponType}-magazines`);
                const magazineList = document.getElementById(`${weaponType}-magazine-list`);
                const magazineInput = document.getElementById(`${weaponType}_magazine_id`);

                const divAmmos = document.getElementById(`div-${weaponType}-ammos`);
                const ammoList = document.getElementById(`${weaponType}-ammo-list`);
                const ammoInput = document.getElementById(`${weaponType}_ammo_id`);

                const divAttachments = document.getElementById(`div-${weaponType}-attachments`);
                const attachmentsSection = document.getElementById(`${weaponType}-attachments-section`);

                weaponCards.forEach(card => {
                    card.addEventListener('click', function () {
                        // Resetar seleções anteriores
                        document.querySelectorAll(`.weapon-card[data-weapon-type="${weaponType}"]`).forEach(c => c.classList.remove('selected'));
                        this.classList.add('selected');

                        const weaponId = this.dataset.weaponId;
                        weaponInput.value = weaponId;

                        // Resetar magazines e ammos
                        divMagazines.classList.add("d-none");
                        divAmmos.classList.add("d-none");
                        divAttachments.classList.add("d-none");
                        magazineInput.value = '';
                        ammoInput.value = '';

                        // Carregar magazines compatíveis
                        fetch(`/get_magazines/${weaponId}`)
                            .then(res => res.json())
                            .then(data => {
                                magazineList.innerHTML = '';
                                if (data.length === 0) {
                                    magazineList.innerHTML = '<p>Nenhum carregador compatível.</p>';
                                } else {
                                    divMagazines.classList.remove("d-none");
                                    data.forEach(mag => {
                                        const card = document.createElement('div');
                                        card.className = 'card m-2 magazine-card';
                                        card.style.width = '100px';
                                        card.dataset.magazineId = mag.id;
                                        card.dataset.weaponType = weaponType;

                                        card.innerHTML = `
                                    <img src="${mag.img}" class="card-img-top" alt="${mag.name}">
                                    <div class="card-body text-center p-1">
                                        <small>${mag.name}</small>
                                    </div>
                                `;

                                        card.addEventListener('click', function () {
                                            document.querySelectorAll(`.magazine-card[data-weapon-type="${weaponType}"]`).forEach(c => c.classList.remove('selected'));
                                            card.classList.add('selected');
                                            magazineInput.value = mag.id;

                                            // Carregar munições compatíveis
                                            loadAmmos(weaponId, weaponType);
                                        });

                                        magazineList.appendChild(card);
                                    });
                                }
                            });

                        // Carregar munições compatíveis
                        loadAmmos(weaponId, weaponType);

                        // Carregar attachments
                        loadAttachments(weaponId, weaponType);
                    });
                });
            }

            // Função para carregar munições
            function loadAmmos(weaponId, weaponType) {
                const divAmmos = document.getElementById(`div-${weaponType}-ammos`);
                const ammoList = document.getElementById(`${weaponType}-ammo-list`);
                const ammoInput = document.getElementById(`${weaponType}_ammo_id`);

                fetch(`/get_ammos/${weaponId}`)
                    .then(res => res.json())
                    .then(data => {
                        ammoList.innerHTML = '';
                        if (data.length === 0) {
                            ammoList.innerHTML = '<p>Nenhuma munição compatível.</p>';
                            ammoInput.value = '';
                        } else {
                            divAmmos.classList.remove("d-none");
                            data.forEach(ammo => {
                                const card = document.createElement('div');
                                card.className = 'card m-2 ammo-card';
                                card.style.width = '100px';
                                card.dataset.ammoId = ammo.id;
                                card.dataset.weaponType = weaponType;

                                card.innerHTML = `
                            <img src="${ammo.img}" class="card-img-top" alt="${ammo.name}">
                            <div class="card-body text-center p-1">
                                <small>${ammo.name}</small>
                            </div>
                        `;

                                card.addEventListener('click', function () {
                                    document.querySelectorAll(`.ammo-card[data-weapon-type="${weaponType}"]`).forEach(c => c.classList.remove('selected'));
                                    card.classList.add('selected');
                                    ammoInput.value = ammo.id;
                                });

                                ammoList.appendChild(card);
                            });
                        }
                    });
            }

            // Função para carregar attachments
            function loadAttachments(weaponId, weaponType) {
                const section = document.getElementById(`${weaponType}-attachments-section`);
                const divAttachments = document.getElementById(`div-${weaponType}-attachments`);
                section.innerHTML = '';

                if (!weaponId) return;

                fetch(`/get_attachments/${weaponId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            divAttachments.classList.remove("d-none");
                        }
                        data.forEach(att => {
                            const card = document.createElement('div');
                            card.className = 'attachment-card col-sm-12 col-lg-3';
                            card.setAttribute('data-id', att.id);
                            card.setAttribute('data-type', att.type);
                            card.setAttribute('data-weapon-type', weaponType);
                            card.setAttribute('title', att.name);
                            card.onclick = () => toggleAttachment(card, weaponType);

                            card.innerHTML = `
                        <img src="${att.img}" alt="${att.name}">
                        <div class="attachment-name">${att.name}</div>
                    `;

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.name = `${weaponType}_attachments`;
                            checkbox.value = att.id;
                            checkbox.id = `${weaponType}-attachment-${att.id}`;
                            checkbox.classList.add('d-none');

                            section.appendChild(card);
                            section.appendChild(checkbox);
                        });
                    })
                    .catch(err => {
                        console.error('Erro ao carregar attachments:', err);
                        section.innerHTML = '<p class="text-danger">Erro ao carregar attachments.</p>';
                    });
            }

            // Função para alternar attachments
            function toggleAttachment(card, weaponType) {
                const type = card.getAttribute('data-type');
                const id = card.getAttribute('data-id');
                const checkbox = document.getElementById(`${weaponType}-attachment-${id}`);

                if (!card.classList.contains('selected')) {
                    // Verifica se já existe um attachment selecionado com o mesmo tipo
                    const alreadySelected = document.querySelector(`.attachment-card.selected[data-type="${type}"][data-weapon-type="${weaponType}"]`);
                    if (alreadySelected) {
                        const name = alreadySelected.querySelector('.attachment-name').textContent;
                        alert(`Você já selecionou um attachment do tipo "${type}" (${name}).`);
                        return;
                    }
                }

                checkbox.checked = !checkbox.checked;
                card.classList.toggle('selected');
            }

            // Configurar os listeners para cada tipo de arma
            setupWeaponSelection('primary');
            setupWeaponSelection('secondary');
            setupWeaponSelection('small');
        });
    </script>
    <!-- Script para Alterar Estilo e Comportamento -->
<script>
    // Quando o colapso é mostrado ou ocultado, alteramos a aparência do botão
    var collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
    
    collapseElements.forEach(function(button) {
        button.addEventListener('click', function() {
            // Remover a classe 'btn-active' de todos os botões
            collapseElements.forEach(function(btn) {
                btn.classList.remove('btn-active');
            });

            // Adiciona a classe 'btn-active' no botão clicado
            if (!button.classList.contains('btn-active')) {
                button.classList.add('btn-active');
            }
        });
    });

    // Usando o "data-bs-parent" para garantir que apenas um colapso esteja aberto de cada vez
    document.addEventListener('DOMContentLoaded', function () {
        var collapseContainers = document.querySelectorAll('.collapse');
        collapseContainers.forEach(function (collapse) {
            collapse.addEventListener('show.bs.collapse', function () {
                // Fecha outros colapsos
                collapseContainers.forEach(function (otherCollapse) {
                    if (otherCollapse !== collapse) {
                        var bsCollapse = new bootstrap.Collapse(otherCollapse, {
                            toggle: false
                        });
                        bsCollapse.hide();
                    }
                });
            });
        });
    });
</script>
</body>

</html>